{% extends 'base.html' %}

{% block title %}{{ produto.nome }} | Maria Raisa{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: auto; padding: 20px;">
  <div style="display: flex; flex-wrap: wrap; gap: 32px; justify-content: center;">

    <!-- Coluna da Imagem e Descrição -->
<div class="produto-detalhe-container">
    <div style="flex: 1 1 300px; max-width: 100%;">
      <img id="mainImage"
           src="{{ url_for('static', filename='images/' ~ produto.imagem_principal) }}"
           alt="{{ produto.nome }}"
           style="width: 100%; max-width: 450px; border-radius: 10px;">

      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
        {% for foto in fotos_extras %}
          <img src="{{ url_for('static', filename='images/' ~ foto.imagem) }}"
               onclick="document.getElementById('mainImage').src=this.src"
               style="width: 64px; height: 64px; object-fit: cover; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">
        {% endfor %}
      </div>

</div>
    </div>



    <!-- Coluna de Detalhes/Compra -->
  <div class="coluna-detalhes-compra">
    <div style="flex: 1 1 300px;">
      <h1 style="font-size: 1.8rem;">{{ produto.nome }}</h1>
      <div style="margin: 12px 0;">
        <p><strong>Preço à Vista:</strong> R$ {{ '%.2f'|format(produto.preco_par) }}</p>
        <p style="color: red;">R$ {{ '%.2f'|format(produto.preco_parcelado) }} em 3x</p>
      </div>

      <p><strong>Categoria:</strong> {{ produto.categoria.nome }}</p>
      <p><strong>Caixa com {{ produto.qtd_minima }} pares</strong></p>

      <!-- Grade -->
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: center;">
          <thead>
            <tr style="background: #f9f9f9;">
              <th style="border: 1px solid #ccc; padding: 8px;">Numeração</th>
              {% for tamanho in produto.grade.keys() %}
                <th style="border: 1px solid #ccc; padding: 8px;">{{ tamanho }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #ccc; padding: 8px;">Quantidade</td>
              {% for qtd in produto.grade.values() %}
                <td style="border: 1px solid #ccc; padding: 8px;">{{ qtd }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Formulário -->
      <form method="POST" action="{{ url_for('routes.adicionar_ao_carrinho', produto_id=produto.id) }}" style="margin-top: 24px;">
        <div>
          <label for="cor">Selecione a cor:</label>
          <select name="cor" id="cor" required>
            <option value="" disabled selected>Escolha</option>
            {% for cor, imagem in cores.items() %}
              <option value="{{ cor }}" data-imagem="{{ url_for('static', filename='images/' ~ imagem) }}">{{ cor }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="margin-top: 12px;">
          <label for="qtd">Qtd. de Caixas:</label>
          <input type="number" name="qtd" id="qtd" min="1" value="1">
        </div>

        <button type="button" class="btn btn-primary" style="margin-top: 16px;" onclick="adicionarAoCarrinho('{{ produto.id }}')">
  Adicionar ao Carrinho
</button>

      </form>
    <div id="mensagem-carrinho" class="flash-success" style="display:none;">
  <span class="icon">✔️</span>
  <span id="texto-mensagem">Produto adicionado ao carrinho com sucesso!</span>
</div>
</div>
    </div>
  </div>
</div>

      <!-- COLUNA DESCRIÇÃO -->
    <div class="coluna-descricao">
        {% if produto.descricao %}
  <div style="max-width: 680px; margin-top: 36px;">
    <h2 style="font-weight: bold; font-size: 1.5rem; color: #111; margin-bottom: 16px;">Descrição</h2>
    <div style="white-space: pre-wrap; font-size: 1.05rem; color: #444; line-height: 1.6;">
      {{ produto.descricao }}
    </div>
  </div>
{% endif %}
</div>


<!-- Script para trocar imagem conforme cor -->
<script>
document.getElementById('cor').addEventListener('change', function () {
  const imagem = this.options[this.selectedIndex].getAttribute('data-imagem');
  if (imagem) {
    document.getElementById('mainImage').src = imagem;
  }
});
</script>

<script>
function showAlert(msg) {
  const alerta = document.getElementById("custom-alert");
  const texto = document.getElementById("custom-alert-msg");
  texto.innerText = msg;
  alerta.style.display = "block";
  setTimeout(() => {
    alerta.style.display = "none";
  }, 4000);
}

function fecharAlerta() {
  document.getElementById("custom-alert").style.display = "none";
}

async function adicionarAoCarrinho(produtoId) {
  const cor = document.querySelector('select[name="cor"]')?.value || '';
  const qtd = document.querySelector('input[name="qtd"]')?.value || 1;

  if (!cor || qtd <= 0) {
    showAlert("Por favor, selecione uma cor e a quantidade.");
    return;
  }

  try {
    const response = await fetch(`/adicionar_ao_carrinho/${produtoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ cor, qtd })
    });

    if (response.ok) {
      const data = await response.json();
      const mensagem = document.getElementById('mensagem-carrinho');
      const texto = document.getElementById('texto-mensagem');
      texto.innerText = data.mensagem;
      mensagem.style.display = 'flex';

      setTimeout(() => {
        mensagem.style.display = 'none';
      }, 4000);
    } else {
      showAlert("Erro ao adicionar ao carrinho.");
    }
  } catch (error) {
    console.error("Erro:", error);
    showAlert("Erro na comunicação com o servidor.");
  }
}
</script>

{% endblock %}
